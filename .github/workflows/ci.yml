name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        config:
          - name: Release
            build_type: Release
          - name: Debug
            build_type: Debug
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install CUDA
      uses: Jimver/cuda-toolkit@v0.2.11
      with:
        cuda: '11.8.0'
    
    - name: Verify CUDA
      run: |
        nvcc --version
        # nvidia-smi may not be available (check if command exists)
        if command -v nvidia-smi &> /dev/null; then
          nvidia-smi
        else
          echo "nvidia-smi not available (expected on some CI runners)"
          echo "CUDA compilation will work, but GPU execution requires physical GPU"
        fi
    
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.28'
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libomp-dev
    
    - name: Configure CMake
      run: |
        mkdir -p build-${{ matrix.config.name }}
        cd build-${{ matrix.config.name }}
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }} \
          -DCUDA_ARCH=sm_75 \
          -DBUILD_EXAMPLES=ON \
          -DBUILD_TESTS=ON \
          -DUSE_CUSOLVER=ON \
          -DUSE_OPENMP=ON
    
    - name: Build
      run: |
        cd build-${{ matrix.config.name }}
        cmake --build . --parallel $(nproc)
    
    - name: Test
      working-directory: build-${{ matrix.config.name }}
      run: |
        ctest --output-on-failure
      continue-on-error: true
    
    - name: Build Documentation
      run: |
        cd build-${{ matrix.config.name }}
        cmake .. -DBUILD_DOCS=ON
        cmake --build . --target docs
      continue-on-error: true
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: matrix.config.name == 'Release'
      with:
        name: linux-build-${{ matrix.config.name }}
        path: |
          build-${{ matrix.config.name }}/lib/*.a
          build-${{ matrix.config.name }}/examples/*
        retention-days: 7

  windows-build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        config:
          - name: Release
            build_type: Release
          - name: Debug
            build_type: Debug
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup CUDA
      uses: Jimver/cuda-toolkit@v0.2.11
      with:
        cuda: '11.8.0'
    
    - name: Add CUDA to PATH
      shell: pwsh
      run: |
        # CUDA_PATH should be set by the action, but verify and add to PATH
        if ($env:CUDA_PATH) {
          $cudaPath = $env:CUDA_PATH
        } else {
          # Fallback to common installation path
          $cudaPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.8"
        }
        $env:PATH = "$cudaPath\bin;$cudaPath\libnvvp;$env:PATH"
        echo "CUDA_PATH=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "$cudaPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    - name: Verify CUDA
      shell: pwsh
      run: |
        nvcc --version
        # nvidia-smi may not be available on GitHub Actions Windows runners (no GPU)
        if (Get-Command nvidia-smi -ErrorAction SilentlyContinue) {
          nvidia-smi
        } else {
          Write-Host "nvidia-smi not available (expected on GitHub Actions Windows runners)"
          Write-Host "CUDA compilation will work, but GPU execution requires physical GPU"
        }
    
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.28'
    
    - name: Configure CMake
      shell: pwsh
      run: |
        $buildDir = "build-${{ matrix.config.name }}"
        New-Item -ItemType Directory -Force -Path $buildDir
        cmake -S . -B $buildDir `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }} `
          -DCUDA_ARCH=sm_75 `
          -DBUILD_EXAMPLES=ON `
          -DBUILD_TESTS=ON `
          -DUSE_CUSOLVER=ON
    
    - name: Build
      shell: pwsh
      run: |
        $buildDir = "build-${{ matrix.config.name }}"
        cmake --build $buildDir --config ${{ matrix.config.build_type }} --parallel
    
    - name: Test
      shell: pwsh
      working-directory: build-${{ matrix.config.name }}
      run: |
        ctest -C ${{ matrix.config.build_type }} --output-on-failure
      continue-on-error: true
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: matrix.config.name == 'Release'
      with:
        name: windows-build-${{ matrix.config.name }}
        path: |
          build-${{ matrix.config.name }}/lib/*.lib
          build-${{ matrix.config.name }}/bin/*.exe
          build-${{ matrix.config.name }}/examples/*.exe
        retention-days: 7

