name: Windows Build (MSBuild)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        config:
          - name: Release
            build_type: Release
          - name: Debug
            build_type: Debug
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup CUDA
      uses: Jimver/cuda-toolkit@v0.2.11
      with:
        cuda: '11.8.0'
    
    - name: Add CUDA to PATH
      shell: pwsh
      run: |
        # CUDA_PATH should be set by the action, but verify and add to PATH
        if ($env:CUDA_PATH) {
          $cudaPath = $env:CUDA_PATH
        } else {
          # Fallback to common installation path
          $cudaPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.8"
        }
        $env:PATH = "$cudaPath\bin;$cudaPath\libnvvp;$env:PATH"
        echo "CUDA_PATH=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "$cudaPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    - name: Verify CUDA Installation
      shell: pwsh
      run: |
        nvcc --version
        # nvidia-smi may not be available on GitHub Actions Windows runners (no GPU)
        # CUDA toolkit is installed for compilation, but GPU execution won't work
        if (Get-Command nvidia-smi -ErrorAction SilentlyContinue) {
          nvidia-smi
        } else {
          Write-Host "nvidia-smi not available (expected on GitHub Actions Windows runners)"
          Write-Host "CUDA compilation will work, but GPU execution requires physical GPU"
        }
    
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.28'
    
    - name: Patch CUDA host_config.h for VS2022 compatibility
      shell: pwsh
      run: |
        # Patch CUDA host_config.h to allow VS2022 14.44+ (needed because compiler detection doesn't use CMAKE_CUDA_FLAGS)
        $hostConfigPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.8\include\crt\host_config.h"
        
        Write-Host "Attempting to patch CUDA host_config.h for VS2022 compatibility"
        Write-Host "Target file: $hostConfigPath"
        
        if (-not (Test-Path $hostConfigPath)) {
          Write-Host "ERROR: host_config.h not found at $hostConfigPath"
          Write-Host "Searching for CUDA installation..."
          $cudaBase = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\"
          if (Test-Path $cudaBase) {
            $cudaDirs = Get-ChildItem $cudaBase -Directory -ErrorAction SilentlyContinue
            Write-Host "Found CUDA directories:"
            $cudaDirs | ForEach-Object { 
              Write-Host "  $($_.FullName)"
              $testPath = Join-Path $_.FullName "include\crt\host_config.h"
              if (Test-Path $testPath) {
                Write-Host "    -> Found host_config.h at: $testPath"
                $hostConfigPath = $testPath
              }
            }
          }
        }
        
        if (Test-Path $hostConfigPath) {
          try {
            Write-Host "Reading host_config.h from: $hostConfigPath"
            
            # Read file as lines (more reliable than -Raw for line-by-line processing)
            $lines = Get-Content $hostConfigPath -ErrorAction Stop
            Write-Host "File has $($lines.Count) lines"
            
            # Find the error line (typically around line 153)
            $patched = $false
            $newLines = @()
            $lineNum = 0
            
            foreach ($line in $lines) {
              $lineNum++
              # Check for the specific error message
              if ($line -match '#error.*unsupported.*Microsoft.*Visual.*Studio.*version') {
                Write-Host "Found error on line $lineNum : $line"
                # Replace with warning
                $newLines += '#warning: VS version check disabled for CI compatibility (VS2022 14.44+)'
                $patched = $true
              } elseif ($line -match '#error.*2022.*inclusive.*supported') {
                Write-Host "Found error on line $lineNum : $line"
                $newLines += '#warning: VS version check disabled for CI compatibility (VS2022 14.44+)'
                $patched = $true
              } else {
                $newLines += $line
              }
            }
            
            if ($patched) {
              Write-Host "Patch successful! Removing read-only attribute..."
              # Remove read-only attribute
              $file = Get-Item $hostConfigPath -ErrorAction Stop
              if ($file.IsReadOnly) {
                $file.IsReadOnly = $false
                Write-Host "Removed read-only attribute"
              }
              
              # Take ownership and set permissions (may require admin, but try anyway)
              try {
                $acl = Get-Acl $hostConfigPath
                $permission = "BUILTIN\Administrators","FullControl","Allow"
                $accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission
                $acl.SetAccessRule($accessRule)
                Set-Acl $hostConfigPath $acl -ErrorAction SilentlyContinue
              } catch {
                Write-Host "Note: Could not modify ACL (may require admin): $_"
              }
              
              # Write patched content
              Write-Host "Writing patched content..."
              $newContent = $newLines -join "`r`n"
              [System.IO.File]::WriteAllText($hostConfigPath, $newContent, [System.Text.Encoding]::UTF8)
              Write-Host "Successfully wrote patched file"
              
              # Verify the patch
              Write-Host "Verifying patch..."
              $verifyLines = Get-Content $hostConfigPath
              $foundWarning = $false
              foreach ($vline in $verifyLines) {
                if ($vline -match '#warning.*VS version check disabled') {
                  Write-Host "SUCCESS: Patch verified - found warning line: $vline"
                  $foundWarning = $true
                  break
                }
              }
              
              if (-not $foundWarning) {
                Write-Host "WARNING: Patch verification failed - warning not found in file"
                Write-Host "Showing lines around expected location:"
                $verifyLines[150..160] | ForEach-Object { Write-Host "  $_" }
              }
            } else {
              Write-Host "ERROR: Could not find error line to patch"
              Write-Host "Searching for relevant lines..."
              $errorLines = $lines | Select-String -Pattern "(error|2022|Visual Studio|unsupported)" | Select-Object -First 10
              if ($errorLines) {
                Write-Host "Found relevant lines:"
                $errorLines | ForEach-Object { Write-Host "  Line $($_.LineNumber): $($_.Line)" }
              } else {
                Write-Host "No relevant lines found - file may already be patched"
              }
              exit 1
            }
          } catch {
            Write-Host "ERROR patching host_config.h: $_"
            Write-Host "Exception type: $($_.Exception.GetType().FullName)"
            Write-Host "Stack trace: $($_.ScriptStackTrace)"
            exit 1
          }
        } else {
          Write-Host "ERROR: Could not locate host_config.h file"
          exit 1
        }
    
    - name: Configure CMake
      shell: pwsh
      env:
        # Set CUDA flags as environment variable (backup method)
        CMAKE_CUDA_FLAGS: "-allow-unsupported-compiler"
        CMAKE_CUDA_FLAGS_INIT: "-allow-unsupported-compiler"
      run: |
        $buildDir = "build-${{ matrix.config.name }}"
        New-Item -ItemType Directory -Force -Path $buildDir
        # Set CUDA flags via multiple methods for maximum compatibility
        cmake -S . -B $buildDir `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }} `
          -DCMAKE_CUDA_FLAGS="-allow-unsupported-compiler" `
          -DCMAKE_CUDA_FLAGS_INIT="-allow-unsupported-compiler" `
          -DCUDA_ARCH=sm_75 `
          -DBUILD_EXAMPLES=ON `
          -DBUILD_TESTS=ON `
          -DUSE_CUSOLVER=ON `
          -DUSE_OPENMP=ON
    
    - name: Build
      shell: pwsh
      run: |
        $buildDir = "build-${{ matrix.config.name }}"
        cmake --build $buildDir --config ${{ matrix.config.build_type }} --parallel
    
    - name: Test
      shell: pwsh
      working-directory: build-${{ matrix.config.name }}
      run: |
        ctest -C ${{ matrix.config.build_type }} --output-on-failure
      continue-on-error: true
    
    - name: Build Documentation
      shell: pwsh
      run: |
        $buildDir = "build-${{ matrix.config.name }}"
        cmake --build $buildDir --target docs --config ${{ matrix.config.build_type }}
      continue-on-error: true
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: matrix.config.name == 'Release'
      with:
        name: windows-build-${{ matrix.config.name }}
        path: |
          build-${{ matrix.config.name }}/lib/*.lib
          build-${{ matrix.config.name }}/bin/*.dll
          build-${{ matrix.config.name }}/bin/*.exe
          build-${{ matrix.config.name }}/examples/*.exe
        retention-days: 7
    
    - name: Upload Documentation
      uses: actions/upload-artifact@v4
      if: matrix.config.name == 'Release'
      with:
        name: windows-docs
        path: build-${{ matrix.config.name }}/docs/doxygen/html
        retention-days: 7
      continue-on-error: true

