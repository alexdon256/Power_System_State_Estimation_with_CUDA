name: Windows Build (MSBuild)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        config:
          - name: Release
            build_type: Release
          - name: Debug
            build_type: Debug
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup CUDA
      uses: Jimver/cuda-toolkit@v0.2.11
      with:
        cuda: '11.8'
        cudnn: '8'
    
    - name: Add CUDA to PATH
      shell: pwsh
      run: |
        $cudaPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.8"
        $env:PATH = "$cudaPath\bin;$cudaPath\libnvvp;$env:PATH"
        echo "CUDA_PATH=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "$cudaPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    - name: Verify CUDA Installation
      shell: pwsh
      run: |
        nvcc --version
        nvidia-smi
    
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.28'
    
    - name: Configure CMake
      shell: pwsh
      run: |
        $buildDir = "build-${{ matrix.config.name }}"
        New-Item -ItemType Directory -Force -Path $buildDir
        cmake -S . -B $buildDir `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }} `
          -DCUDA_ARCH=sm_75 `
          -DBUILD_EXAMPLES=ON `
          -DBUILD_TESTS=ON `
          -DUSE_CUSOLVER=ON
    
    - name: Build
      shell: pwsh
      run: |
        $buildDir = "build-${{ matrix.config.name }}"
        cmake --build $buildDir --config ${{ matrix.config.build_type }} --parallel
    
    - name: Test
      shell: pwsh
      working-directory: build-${{ matrix.config.name }}
      run: |
        ctest -C ${{ matrix.config.build_type }} --output-on-failure
      continue-on-error: true
    
    - name: Build Documentation
      shell: pwsh
      run: |
        $buildDir = "build-${{ matrix.config.name }}"
        cmake --build $buildDir --target docs --config ${{ matrix.config.build_type }}
      continue-on-error: true
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: matrix.config.name == 'Release'
      with:
        name: windows-build-${{ matrix.config.name }}
        path: |
          build-${{ matrix.config.name }}/lib/*.lib
          build-${{ matrix.config.name }}/bin/*.exe
          build-${{ matrix.config.name }}/examples/*.exe
        retention-days: 7
    
    - name: Upload Documentation
      uses: actions/upload-artifact@v4
      if: matrix.config.name == 'Release'
      with:
        name: windows-docs
        path: build-${{ matrix.config.name }}/docs/doxygen/html
        retention-days: 7
      continue-on-error: true

