name: Windows Build (MSBuild)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        config:
          - name: Release
            build_type: Release
          - name: Debug
            build_type: Debug
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup CUDA
      uses: Jimver/cuda-toolkit@v0.2.11
      with:
        cuda: '11.8.0'
    
    - name: Add CUDA to PATH
      shell: pwsh
      run: |
        # CUDA_PATH should be set by the action, but verify and add to PATH
        if ($env:CUDA_PATH) {
          $cudaPath = $env:CUDA_PATH
        } else {
          # Fallback to common installation path
          $cudaPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.8"
        }
        $env:PATH = "$cudaPath\bin;$cudaPath\libnvvp;$env:PATH"
        echo "CUDA_PATH=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "$cudaPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    - name: Verify CUDA Installation
      shell: pwsh
      run: |
        nvcc --version
        # nvidia-smi may not be available on GitHub Actions Windows runners (no GPU)
        # CUDA toolkit is installed for compilation, but GPU execution won't work
        if (Get-Command nvidia-smi -ErrorAction SilentlyContinue) {
          nvidia-smi
        } else {
          Write-Host "nvidia-smi not available (expected on GitHub Actions Windows runners)"
          Write-Host "CUDA compilation will work, but GPU execution requires physical GPU"
        }
    
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.28'
    
    - name: Patch CUDA host_config.h for VS2022 compatibility
      shell: pwsh
      run: |
        # Patch CUDA host_config.h to allow VS2022 14.44+ (needed because compiler detection doesn't use CMAKE_CUDA_FLAGS)
        $hostConfigPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.8\include\crt\host_config.h"
        if (Test-Path $hostConfigPath) {
          try {
            # Read file content
            $content = Get-Content $hostConfigPath -Raw -ErrorAction Stop
            # Find and replace the version check error (line 153 typically)
            # Pattern matches: #error: -- unsupported Microsoft Visual Studio version! Only the versions between 2017 and 2022 (inclusive) are supported!
            $oldPattern = '#error\s*:\s*--\s*unsupported\s+Microsoft\s+Visual\s+Studio\s+version[^\n]*'
            if ($content -match $oldPattern) {
              $newContent = $content -replace $oldPattern, '#warning: VS version check disabled for CI compatibility (VS2022 14.44+)'
              # Remove read-only attribute if present
              $file = Get-Item $hostConfigPath -ErrorAction Stop
              if ($file.IsReadOnly) {
                $file.IsReadOnly = $false
              }
              # Write patched content
              Set-Content $hostConfigPath -Value $newContent -NoNewline -ErrorAction Stop
              Write-Host "Successfully patched CUDA host_config.h for VS2022 compatibility"
            } else {
              Write-Host "Warning: Could not find version check pattern in host_config.h (may already be patched)"
            }
          } catch {
            Write-Host "Error patching host_config.h: $_"
            Write-Host "Will rely on CMAKE_CUDA_FLAGS instead"
          }
        } else {
          Write-Host "Warning: host_config.h not found at $hostConfigPath"
        }
    
    - name: Configure CMake
      shell: pwsh
      env:
        # Set CUDA flags as environment variable (backup method)
        CMAKE_CUDA_FLAGS: "-allow-unsupported-compiler"
      run: |
        $buildDir = "build-${{ matrix.config.name }}"
        New-Item -ItemType Directory -Force -Path $buildDir
        # Set CUDA flags via multiple methods for maximum compatibility
        cmake -S . -B $buildDir `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }} `
          -DCMAKE_CUDA_FLAGS="-allow-unsupported-compiler" `
          -DCUDA_ARCH=sm_75 `
          -DBUILD_EXAMPLES=ON `
          -DBUILD_TESTS=ON `
          -DUSE_CUSOLVER=ON `
          -DUSE_OPENMP=ON
    
    - name: Build
      shell: pwsh
      run: |
        $buildDir = "build-${{ matrix.config.name }}"
        cmake --build $buildDir --config ${{ matrix.config.build_type }} --parallel
    
    - name: Test
      shell: pwsh
      working-directory: build-${{ matrix.config.name }}
      run: |
        ctest -C ${{ matrix.config.build_type }} --output-on-failure
      continue-on-error: true
    
    - name: Build Documentation
      shell: pwsh
      run: |
        $buildDir = "build-${{ matrix.config.name }}"
        cmake --build $buildDir --target docs --config ${{ matrix.config.build_type }}
      continue-on-error: true
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: matrix.config.name == 'Release'
      with:
        name: windows-build-${{ matrix.config.name }}
        path: |
          build-${{ matrix.config.name }}/lib/*.lib
          build-${{ matrix.config.name }}/bin/*.dll
          build-${{ matrix.config.name }}/bin/*.exe
          build-${{ matrix.config.name }}/examples/*.exe
        retention-days: 7
    
    - name: Upload Documentation
      uses: actions/upload-artifact@v4
      if: matrix.config.name == 'Release'
      with:
        name: windows-docs
        path: build-${{ matrix.config.name }}/docs/doxygen/html
        retention-days: 7
      continue-on-error: true

